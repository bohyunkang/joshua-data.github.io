<!DOCTYPE html>
<html>
  <head>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K04Y972F7E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-K04Y972F7E');
  </script>

  <!-- Google Adsense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3596487245525606"
    crossorigin="anonymous">
  </script>

  <title>Intro to Encoding & Decoding Ethereum Contract Functions – Joshua Kim – Analytics Engineer | Data Analyst</title>

      <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="
  In this article, I will briefly explore the Ethereum ABI Specification and show you how to decode contract functions when conducting on-chain data analysis. Additionally, I will demonstrate a simple data extraction and analysis case about “Who are the Top 10 Recipients of USDT approve Functions?” using DuneSQL while handling ABIs.

" />
    <meta property="og:description" content="
  In this article, I will briefly explore the Ethereum ABI Specification and show you how to decode contract functions when conducting on-chain data analysis. Additionally, I will demonstrate a simple data extraction and analysis case about “Who are the Top 10 Recipients of USDT approve Functions?” using DuneSQL while handling ABIs.

" />
    
    <meta name="author" content="Joshua Kim" />

    
    <meta property="og:title" content="Intro to Encoding & Decoding Ethereum Contract Functions" />
    <meta property="twitter:title" content="Intro to Encoding & Decoding Ethereum Contract Functions" />
    
  <!-- Async font loading -->
<script>
  window.WebFontConfig = {
      custom: {
          families: ['Spoqa Han Sans:100,300,400,700'],
          urls: ['https://spoqa.github.io/spoqa-han-sans/css/SpoqaHanSans-kr.css']
      },
      timeout: 60000
  };
  (function(d) {
      var wf = d.createElement('script'), s = d.scripts[0];
      wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
      s.parentNode.insertBefore(wf, s);
  })(document);
</script>


  

  <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link rel="stylesheet" type="text/css" href="/style.css" />
  <link rel="alternate" type="application/rss+xml" title="Joshua Kim - Analytics Engineer | Data Analyst" href="/feed.xml" />

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/logo/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/logo/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/logo/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/logo/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/logo/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/logo/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/logo/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/logo/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/logo/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/logo/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/logo/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
</head>

  <body>      

    <a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fjoshua-data.github.io&count_bg=%2379C83D&title_bg=%23555555&icon=ghostery.svg&icon_color=%23E7E7E7&title=hits&edge_flat=false"/></a>

    <div class="wrapper-masthead">
  <div class="container">
    <header class="masthead clearfix">
      
        <a href="/" class="site-avatar"><img src="https://avatars.githubusercontent.com/u/144670043?v=4" /></a>
      

      <div class="site-info">
        <h1 class="site-name"><a href="/">Joshua Kim</a></h1>
        <p class="site-description">Analytics Engineer | Data Analyst</p>
      </div>

      <nav>
        
        
        <a href="/about">About</a>
        
        
        
        <a href="/">Articles</a>
        
        
        
        <a href="/archive">Archive</a>
        
        
        
        <a href="/tags">Tags</a>
        
        
      </nav>
    </header>
  </div>
</div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Intro to Encoding & Decoding Ethereum Contract Functions</h1>

  <div>
    <span class="date">
      2023-10-16
    </span>

    <ul class="tag">
      
      <li>
        <a href="http://localhost:4000/tags#Blockchain">
          Blockchain
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#On-chain Data">
          On-chain Data
        </a>
      </li>
      
      <li>
        <a href="http://localhost:4000/tags#SQL">
          SQL
        </a>
      </li>
      
    </ul>
  </div>

  <div class="entry">
    <blockquote>
  <p>In this article, I will briefly explore the Ethereum ABI Specification and show you how to decode contract functions when conducting on-chain data analysis. Additionally, I will demonstrate a simple data extraction and analysis case about “Who are the Top 10 Recipients of USDT approve Functions?” using DuneSQL while handling ABIs.</p>
</blockquote>

<h3 id="contents">CONTENTS</h3>
<ol>
  <li>Argument Types Key Content
    <ul>
      <li>1.1. Elementary Types</li>
      <li>1.2. Fixed-size Types</li>
      <li>1.3. Dynamic-size Types</li>
    </ul>
  </li>
  <li>Key Points of Argument Padding to 32 Bytes Rules</li>
  <li>A Contract Example
    <ul>
      <li>3.1. How to Call <code class="language-plaintext highlighter-rouge">baz(uint32 x, bool y)</code></li>
      <li>3.2. How to Call <code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code></li>
      <li>3.3. How to Call <code class="language-plaintext highlighter-rouge">sam(bytes, bool, uint[])</code></li>
    </ul>
  </li>
  <li>Case Study: Who are the Top 10 Recipients of USDT <code class="language-plaintext highlighter-rouge">approve</code> Functions?
    <ul>
      <li>4.1. Function Selector</li>
      <li>4.2. Extract only the transactions that have called the <code class="language-plaintext highlighter-rouge">approve</code> function on the USDT Contract.</li>
      <li>4.3. Extract the first argument value, <code class="language-plaintext highlighter-rouge">address</code>, from the functions.</li>
      <li>4.4. Now, aggregate the number of unique addresses that executed <code class="language-plaintext highlighter-rouge">approve</code> function, grouped by each <code class="language-plaintext highlighter-rouge">approve</code> recipient, over the past week.</li>
      <li>4.5. Label the <code class="language-plaintext highlighter-rouge">approve</code> recipient addresses based on Dune Tables regarding “address labeling”.</li>
      <li>4.6. The Final Query Results</li>
    </ul>
  </li>
  <li>Let’s Conclude!</li>
  <li>References</li>
</ol>

<hr />

<h1 id="1-argument-types-key-content">1. Argument Types Key Content</h1>

<p>Before diving into the Ethereum ABI specification, let’s take a quick look at the argument data types of Ethereum contracts. Ethereum contract functions can have various parameter data types, and among them, I have listed some of the important types and summarize their key characteristics.</p>

<h2 id="11-elementary-types">1.1. Elementary Types</h2>

<p><code class="language-plaintext highlighter-rouge">uint</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">uint256</code>,</li>
  <li>which means it should be considered as  <code class="language-plaintext highlighter-rouge">uint256</code>  type during encoding.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">int</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">int256</code>,</li>
  <li>which means it should be considered as  <code class="language-plaintext highlighter-rouge">int256</code>  type during encoding.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bool</code></p>
<ul>
  <li>Same as  <code class="language-plaintext highlighter-rouge">uint8</code>,</li>
  <li>which means only 0 or 1 can be assigned to it.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bytes{n}</code></p>
<ul>
  <li>Binary type with a length of n bytes (0 &lt; n ≤ 32)</li>
</ul>

<h2 id="12-fixed-size-types">1.2. Fixed-size Types</h2>

<p><code class="language-plaintext highlighter-rouge">{type_name}[{n}]</code></p>
<ul>
  <li>An array with n elements (n ≥ 0)</li>
</ul>

<h2 id="13-dynamic-size-types">1.3. Dynamic-size Types</h2>

<p><code class="language-plaintext highlighter-rouge">bytes</code></p>
<ul>
  <li>Binary type with a dynamic length of bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">string</code></p>
<ul>
  <li>A dynamically sized string (assuming it’s UTF-8 encoded)</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">{type_name}[]</code></p>
<ul>
  <li>An array with a dynamic number of elements</li>
</ul>

<h1 id="2-key-points-of-argument-padding-to-32-bytes-rules">2. Key Points of Argument Padding to 32 Bytes Rules</h1>

<p>When calling Ethereum contract functions, you need to encode each argument and input them concatenated. In this process, there are rules regarding “length.” To avoid confusion, I’ve summarized the key rules for you in advance.</p>

<p><code class="language-plaintext highlighter-rouge">uint{n}</code></p>
<ul>
  <li>Padding with preceding 0 to achieve a length of 32 bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">int{n}</code></p>
<ul>
  <li>Padding with preceding 0 to achieve a length of 32 bytes</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">bytes{n}</code></p>
<ul>
  <li>Padding with trailing 0 to achieve a length of 32 bytes</li>
</ul>

<h1 id="3-a-contract-example">3. A Contract Example</h1>

<p>The following example has been taken from  <a href="https://docs.soliditylang.org/en/develop/abi-spec.html#examples">Contract ABI Specification Docs</a>. Let me explain this in simpler terms.</p>

<p><strong>Given the Contract:</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.4</span><span class="p">.</span><span class="mi">16</span><span class="p">;</span>  
  
<span class="nx">contract</span> <span class="nx">Foo</span> <span class="p">{</span>  
  <span class="kd">function</span> <span class="nf">baz</span><span class="p">(</span><span class="nx">uint32</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">bool</span> <span class="nx">y</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="nf">returns </span><span class="p">(</span><span class="nx">bool</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="o">||</span> <span class="nx">y</span><span class="p">;</span> <span class="p">}</span>  
  <span class="kd">function</span> <span class="nf">bar</span><span class="p">(</span><span class="nx">bytes3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="p">{}</span>  
  <span class="kd">function</span> <span class="nf">sam</span><span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">bool</span><span class="p">,</span> <span class="nx">uint</span><span class="p">[])</span> <span class="kr">public</span> <span class="nx">pure</span> <span class="p">{}</span>  
<span class="p">}</span>
</code></pre></div></div>

<h2 id="31-how-to-call-bazuint32-x-bool-y">3.1. How to Call <code class="language-plaintext highlighter-rouge">baz(uint32 x, bool y)</code></h2>

<p>Let’s say you’re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">baz(69, true)</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">baz(uint32,bool)</code>  → Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0992ec5bbfc459984220f8c45084cc24d9b6efed1fae540db8de801d2</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 1:</strong>  <code class="language-plaintext highlighter-rouge">69</code></p>
<ul>
  <li>Convert it to hexadecimal.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x45</span>
</code></pre></div>    </div>
  </li>
  <li>Left pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000045</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 2:</strong>  <code class="language-plaintext highlighter-rouge">true</code></p>
<ul>
  <li>Convert it to uint8.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span>
</code></pre></div>    </div>
  </li>
  <li>Left pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xcdcd77c0</span> <span class="c1"># Function Selector  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000045</span> <span class="c1"># 69  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># true  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xdcdcd77c000000000000000000000000000000000000000000000000000000000000000450000000000000000000000000000000000000000000000000000000000000001</span>
</code></pre></div></div>

<h2 id="32-how-to-call-barbytes32">3.2. How to Call <code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code></h2>

<p>Let’s say you’re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">baz("abc", "def")</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">bar(bytes3[2])</code>  → Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f601a3db60cb33e4b6ef4f91e4465eaf93c292b64fcde1bf4ba6819b6a</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f6</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 1:</strong>  <code class="language-plaintext highlighter-rouge">“abc”</code></p>
<ul>
  <li>Convert it to utf-8 bytes (<a href="https://onlinetools.com/utf8/convert-utf8-to-bytes">String to UTF-8 Bytes Convertor</a>)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">616263</span>
</code></pre></div>    </div>
  </li>
  <li>Right pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x6162630000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameter 2</strong>:  <code class="language-plaintext highlighter-rouge">“def”</code></p>
<ul>
  <li>Convert it to utf-8 bytes (<a href="https://onlinetools.com/utf8/convert-utf8-to-bytes">String to UTF-8 Bytes Convertor</a>)
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">646566</span>
</code></pre></div>    </div>
  </li>
  <li>Right pad it to a length of 32 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x6465660000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xfce353f6</span> <span class="c1"># Function Selector  
</span><span class="mi">6162630000000000000000000000000000000000000000000000000000000000</span> <span class="c1"># "abc"  
</span><span class="mi">6465660000000000000000000000000000000000000000000000000000000000</span> <span class="c1"># "def"  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xfce353f661626300000000000000000000000000000000000000000000000000000000006465660000000000000000000000000000000000000000000000000000000000</span>
</code></pre></div></div>

<h2 id="33-how-to-call-sambytes-bool-uint">3.3. How to Call <code class="language-plaintext highlighter-rouge">sam(bytes, bool, uint[])</code></h2>

<p>Let’s say you’re calling the function in the format of:  <code class="language-plaintext highlighter-rouge">sam(“dave”, true, [1, 2, 3])</code></p>

<p><strong>Function Selector</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">sam(bytes,bool,uint256[])</code>  → Keccak-256 Hash</li>
  <li>Note that  <code class="language-plaintext highlighter-rouge">uint</code>  is replaced with its canonical representation  <code class="language-plaintext highlighter-rouge">uint256</code>.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf27e2786816613d3eeb0b62650200b5a98766dfcfd4428f296fb56d043</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf2</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>Parameters</strong></p>
<ul>
  <li>In the order of: “<strong>iLoc &gt; Len &gt; Value</strong>”</li>
</ul>

<p><img src="/assets/2023-10-16-encoding-and-decoding-ethereum-contract-functions/parameters.webp" alt="" /></p>
<blockquote>
  <p>made by Joshua</p>
</blockquote>

<p><strong>The Final Encoding with Concatenating All</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0xa5643bf2</span> <span class="c1"># Function Selector  
</span>  
<span class="mh">0x0000000000000000000000000000000000000000000000000000000000000060</span> <span class="c1"># 1st Param iLoc : 96 bytes  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># 2nd Param Value : true   
</span><span class="mh">0x00000000000000000000000000000000000000000000000000000000000000a0</span> <span class="c1"># 3rd Param iLoc : 160 bytes  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000004</span> <span class="c1"># 1st Param Len : 4 bytes  
</span><span class="mh">0x6461766500000000000000000000000000000000000000000000000000000000</span> <span class="c1"># 1sst Param Value : "dave"  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000003</span> <span class="c1"># 3rd Params Len : 3 items  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000001</span> <span class="c1"># 3rd Param Value (item 0) : 1  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000002</span> <span class="c1"># 3rd Param Value (item 1) : 2  
</span><span class="mh">0x0000000000000000000000000000000000000000000000000000000000000003</span> <span class="c1"># 3rd Param Value (item 2) : 3  
</span>  
<span class="c1"># Concat  
</span><span class="mh">0xa5643bf20000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000464617665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003</span>
</code></pre></div></div>

<h1 id="4-case-study-who-are-the-top-10-recipients-of-usdt-approve-functions">4. Case Study: Who are the Top 10 Recipients of USDT <code class="language-plaintext highlighter-rouge">approve</code> Functions?</h1>

<p>According to  <a href="https://docs.openzeppelin.com/contracts/2.x/api/token/erc20">ERC-20 Interface</a>, it is possible to delegate the permission to use a specific token (the authority to transfer the token, specifically) to a particular account using the <code class="language-plaintext highlighter-rouge">approve</code> function. This permission is frequently requested, particularly in DeFi platforms. In this case study, I aim to aggregate and analyze the top 10 accounts that people commonly delegate their USDT through <code class="language-plaintext highlighter-rouge">approve</code> function.</p>

<h2 id="41-function-selector">4.1. Function Selector</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">approve(address,uint256)</code>  → Keccak-256 Hash
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x095ea7b334ae44009aa867bfb386f5c3b4b443ac6f0ee573fa91c4608fbadfba</span>
</code></pre></div>    </div>
  </li>
  <li>Slice the left 4 bytes.
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x095ea7b3</span>
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="42-extract-only-the-transactions-that-have-called-the-approve-function-on-the-usdt-contract">4.2. Extract only the transactions that have called the <code class="language-plaintext highlighter-rouge">approve</code> function on the USDT Contract.</h2>

<ul>
  <li>For more info about <code class="language-plaintext highlighter-rouge">BYTEARRAY_STARTS_WITH</code> Function, click  <a href="https://dune.com/docs/query/DuneSQL-reference/Functions-and-operators/varbinary/#bytearray_starts_with">here</a>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="o">*</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call</span>
</code></pre></div></div>

<h2 id="43-extract-the-first-argument-value-address-from-the-functions">4.3. Extract the first argument value, <code class="language-plaintext highlighter-rouge">address</code>, from the functions.</h2>

<ul>
  <li>For more info about <code class="language-plaintext highlighter-rouge">BYTEARRAY_SUBSTRING</code> Function, click  <a href="https://dune.com/docs/query/DuneSQL-reference/Functions-and-operators/varbinary/#bytearray_substring">here</a>.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
        <span class="mi">13</span><span class="p">,</span>  
        <span class="mi">20</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call</span>
</code></pre></div></div>

<h2 id="44-now-aggregate-the-number-of-unique-addresses-that-executed-approve-function-grouped-by-each-approve-recipient-over-the-past-week">4.4. Now, aggregate the number of unique addresses that executed <code class="language-plaintext highlighter-rouge">approve</code> function, grouped by each <code class="language-plaintext highlighter-rouge">approve</code> recipient, over the past week.</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  
    <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
        <span class="mi">13</span><span class="p">,</span>  
        <span class="mi">20</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span><span class="p">,</span>  
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="nv">"from"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">approved_from_cnt</span>  
<span class="k">FROM</span>  
    <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
<span class="k">WHERE</span>  
    <span class="k">CAST</span><span class="p">(</span><span class="n">block_date</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="c1">-- Recent 7 Days  </span>
    <span class="k">AND</span> <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
    <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call  </span>
<span class="k">GROUP</span> <span class="k">BY</span>  
    <span class="mi">1</span>
</code></pre></div></div>

<h2 id="45-label-the-approve-recipient-addresses-based-on-dune-tables-regarding-address-labeling">4.5. Label the <code class="language-plaintext highlighter-rouge">approve</code> recipient addresses based on Dune Tables regarding “address labeling”.</h2>

<ul>
  <li>Looking at the original address values alone does not provide any meaningful information, as y’all know here.</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span>  
<span class="n">CTE_approves</span> <span class="k">AS</span> <span class="p">(</span>  
    <span class="k">SELECT</span>  
        <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span>  
            <span class="n">BYTEARRAY_SUBSTRING</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>  
            <span class="mi">13</span><span class="p">,</span>  
            <span class="mi">20</span>  
        <span class="p">)</span> <span class="k">AS</span> <span class="n">approved_to</span><span class="p">,</span>  
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="nv">"from"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">approved_from_cnt</span>  
    <span class="k">FROM</span>  
        <span class="n">ethereum</span><span class="p">.</span><span class="n">transactions</span>  
    <span class="k">WHERE</span>  
        <span class="k">CAST</span><span class="p">(</span><span class="n">block_date</span> <span class="k">AS</span> <span class="nb">DATE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">DATE_ADD</span><span class="p">(</span><span class="s1">'DAY'</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="k">CURRENT_DATE</span><span class="p">)</span> <span class="c1">-- Recent 7 Days  </span>
        <span class="k">AND</span> <span class="nv">"to"</span> <span class="o">=</span> <span class="mi">0</span><span class="n">xdAC17F958D2ee523a2206206994597C13D831ec7</span> <span class="c1">-- USDT ERC-20 Contract  </span>
        <span class="k">AND</span> <span class="n">BYTEARRAY_STARTS_WITH</span><span class="p">(</span><span class="k">data</span><span class="p">,</span> <span class="mi">0</span><span class="n">x095ea7b3</span><span class="p">)</span> <span class="c1">-- approve(address,uint256) Function Call  </span>
    <span class="k">GROUP</span> <span class="k">BY</span>  
        <span class="mi">1</span>  
<span class="p">)</span>  
  
<span class="k">SELECT</span>  
    <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span><span class="p">,</span>  
    <span class="n">COALESCE</span><span class="p">(</span>  
        <span class="n">SUB1</span><span class="p">.</span><span class="n">dex_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB1</span><span class="p">.</span><span class="n">distinct_name</span><span class="p">,</span>  
        <span class="n">SUB2</span><span class="p">.</span><span class="n">project</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB2</span><span class="p">.</span><span class="n">project_type</span><span class="p">,</span>  
        <span class="n">SUB3</span><span class="p">.</span><span class="n">bridge_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB3</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>  
        <span class="n">SUB4</span><span class="p">.</span><span class="n">cex_name</span> <span class="o">||</span> <span class="s1">' - '</span> <span class="o">||</span> <span class="n">SUB4</span><span class="p">.</span><span class="n">distinct_name</span><span class="p">,</span>  
        <span class="s1">'Unknown'</span>  
    <span class="p">)</span> <span class="k">AS</span> <span class="n">name</span><span class="p">,</span>  
    <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_from_cnt</span> <span class="k">AS</span> <span class="n">addresses_cnt</span>  
<span class="k">FROM</span>  
    <span class="n">CTE_approves</span> <span class="n">MAIN</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">dex</span> <span class="n">SUB1</span> <span class="c1">-- DEX named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB1</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">defi</span> <span class="n">SUB2</span> <span class="c1">-- DeFi named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB2</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">bridges</span> <span class="n">SUB3</span> <span class="c1">-- Bridge named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB3</span><span class="p">.</span><span class="n">address</span>  
<span class="k">LEFT</span> <span class="k">JOIN</span>  
    <span class="n">addresses_ethereum</span><span class="p">.</span><span class="n">cex</span> <span class="n">SUB4</span> <span class="c1">-- CEX named addresses  </span>
    <span class="k">ON</span> <span class="n">MAIN</span><span class="p">.</span><span class="n">approved_to</span> <span class="o">=</span> <span class="n">SUB4</span><span class="p">.</span><span class="n">address</span>  
<span class="k">ORDER</span> <span class="k">BY</span>  
    <span class="mi">3</span> <span class="k">DESC</span>  
<span class="k">LIMIT</span>  
    <span class="mi">10</span>  
<span class="p">;</span>
</code></pre></div></div>

<h2 id="46-the-final-query-results">4.6. The Final Query Results</h2>

<p><img src="/assets/2023-10-16-encoding-and-decoding-ethereum-contract-functions/query-results.webp" alt="" /></p>
<blockquote>
  <p>Dune Analytics</p>
</blockquote>

<h1 id="5-lets-conclude">5. Let’s Conclude!</h1>

<p>So far, we have delved into <strong>the Ethereum’s ABI Specification</strong>, learned how data is encoded when transactions call contract functions, and understood how to extract meaningful insights by decoding specific function names and arguments from Ethereum transactions data.</p>

<p>In fact, Dune Analytics, Etherscan, and many other on-chain data platforms all incorporate these decoding processes internally.</p>

<p>Hopefully this article will serve as an excellent foundation for your future, more detailed and complex on-chain data analysis endeavors.</p>

<h1 id="6-references">6. References</h1>

<ul>
  <li><a href="https://docs.soliditylang.org/en/develop/abi-spec.html#function-selector-and-argument-encoding">Contract ABI Specification</a></li>
  <li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc721">OpenZeppelin Docs</a></li>
  <li><a href="https://dune.com/joshua_web3">Dune Analytics</a></li>
</ul>

<hr />

<h2 id="published-by-joshua-kim"><em>Published by</em> Joshua Kim</h2>
<p><img src="/assets/profile/joshua-profile.png" alt="Joshua Kim" /></p>

  </div>

  <div class="pagination">
    
      <span class="prev" >
          <a href="http://localhost:4000/finding-nfts/">
            &#xE000; Finding all NFTs (ERC721) held by an address (feat. Dune Analytics)
          </a>
      </span>
    
    
      <span class="next" >
          <a href="http://localhost:4000/near-protocol/">
            Near Protocol: Account Model and Transaction Story &#xE001;
          </a>
      </span>
    
  </div>

  <script type="text/javascript"
  src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js">
</script>
<script>
$(document).ready(function() {
    mermaid.initialize({
        theme: 'forest'
    });
});
</script>
  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <!-- Refer to https://codepen.io/ruandre/pen/howFi -->
<ul class="svg-icon">

  

  

  
  <li><a href="mailto:joshuajkim413@gmail.com" class="icon-8 email" title="Email"><svg viewBox="0 0 512 512"><path d="M101.3 141.6v228.9h0.3 308.4 0.8V141.6H101.3zM375.7 167.8l-119.7 91.5 -119.6-91.5H375.7zM127.6 194.1l64.1 49.1 -64.1 64.1V194.1zM127.8 344.2l84.9-84.9 43.2 33.1 43-32.9 84.7 84.7L127.8 344.2 127.8 344.2zM384.4 307.8l-64.4-64.4 64.4-49.3V307.8z"/></svg><!--[if lt IE 9]><em>Email</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://github.com/joshua-data" class="icon-13 github" title="GitHub"><svg viewBox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"/></svg><!--[if lt IE 9]><em>GitHub</em><![endif]--></a></li>
  

  

  

  
  <li><a href="https://www.linkedin.com/in/joshuajsk" class="icon-17 linkedin" title="LinkedIn"><svg viewBox="0 0 512 512"><path d="M186.4 142.4c0 19-15.3 34.5-34.2 34.5 -18.9 0-34.2-15.4-34.2-34.5 0-19 15.3-34.5 34.2-34.5C171.1 107.9 186.4 123.4 186.4 142.4zM181.4 201.3h-57.8V388.1h57.8V201.3zM273.8 201.3h-55.4V388.1h55.4c0 0 0-69.3 0-98 0-26.3 12.1-41.9 35.2-41.9 21.3 0 31.5 15 31.5 41.9 0 26.9 0 98 0 98h57.5c0 0 0-68.2 0-118.3 0-50-28.3-74.2-68-74.2 -39.6 0-56.3 30.9-56.3 30.9v-25.2H273.8z"/></svg><!--[if lt IE 9]><em>LinkedIn</em><![endif]--></a></li>
  

  

  

  

  

  

  

</ul>



<p>© Joshua Kim</p>

        </footer>
      </div>
    </div>

    

  </body>
</html>
